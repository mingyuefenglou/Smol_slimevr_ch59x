# SlimeVR CH59X 代码问题分析报告

**分析日期**: 2026-01-17  
**对比版本**: nRF 官方固件 vs CH59X 当前实现

---

## 一、官方 nRF 固件分析

### 1.1 文件大小对比

| 组件 | nRF 官方 | CH59X 当前 | 差异 |
|------|----------|------------|------|
| Tracker UF2 | **449 KB** | 12 KB | ❌ 差 37 倍 |
| Receiver UF2 | **194 KB** | 3.5 KB | ❌ 差 55 倍 |
| Tracker BIN | ~224 KB | 11 KB | ❌ 严重不足 |
| Receiver BIN | ~97 KB | 2.9 KB | ❌ 严重不足 |

### 1.2 原因分析

当前固件大小仅有 11-14 KB，原因：
1. **大量代码是框架/声明**，没有完整实现
2. **USB 中断处理未完成** (TODO: Handle setup)
3. **RF 接收未完整实现**
4. **VQF 算法未链接到主程序**
5. **没有实际的数据处理循环**

---

## 二、发现的具体问题

### 2.1 ❌ Bootloader 未集成

**问题**: 代码中有 `usb_bootloader.c/.h`，但：
- 没有独立的 bootloader 分区
- APP 起始地址应该是 `0x1000` (4KB after bootloader)
- 当前 APP 从 `0x0000` 开始

**修正方案**:
```c
// 链接脚本需要修改
MEMORY {
    BOOTLOADER (rx) : ORIGIN = 0x00000000, LENGTH = 4K
    FLASH (rx)      : ORIGIN = 0x00001000, LENGTH = 188K  /* 192K - 4K bootloader */
    RAM (xrw)       : ORIGIN = 0x20000000, LENGTH = 24K
}
```

### 2.2 ❌ IMU 枚举问题

**问题**: config.h 中 IMU 枚举正确，但检测逻辑需要改进

当前枚举 (正确):
```c
#define IMU_UNKNOWN         0
#define IMU_MPU6050         1
#define IMU_BMI160          2
#define IMU_BMI270          3
#define IMU_ICM42688        4
#define IMU_ICM45686        5
#define IMU_LSM6DSV         6   // ✅ 已包含
#define IMU_LSM6DSR         7   // ✅ 已包含
```

**建议添加**: 更多 IMU 支持
```c
#define IMU_ICM20948        8   // 9轴
#define IMU_MPU9250         9   // 9轴
#define IMU_LSM6DSO         10  // 常用
```

### 2.3 ❌ USB Setup 处理未完成

**位置**: `src/usb/usb_hid_slime.c:141`

```c
case UIS_TOKEN_SETUP:
    // TODO: Handle setup  <-- 严重！
    break;
```

**需要完整实现** USB 标准请求处理：
- GET_DESCRIPTOR
- SET_ADDRESS  
- SET_CONFIGURATION
- SET_INTERFACE
- HID class requests

### 2.4 ❌ RF 协议过于简化

**当前状态**: 基本框架，缺少：
- 完整的 ESB 兼容层
- 丢包重传机制
- RSSI 测量
- 信道质量评估
- 自适应跳频

### 2.5 ⚠️ VQF 算法选择

**当前**: 默认使用 `vqf_ultra` (Q15 定点优化版)
**问题**: config.h 注释说使用"完整VQF"，但实际链接的是优化版

**建议**: 
- 保持使用 `vqf_ultra` (更适合嵌入式)
- 或提供编译选项选择版本

### 2.6 ⚠️ 版本号缺失

**问题**: 没有从 GitHub 获取版本号的机制

---

## 三、nRF 官方固件特性

### 3.1 SlimeNRF Tracker 特性 (449KB)

从文件名 `SlimeNRF_Tracker_NoSleep_SPI_StackedSmol.uf2` 分析：
- **NoSleep**: 禁用深度睡眠模式
- **SPI**: 使用 SPI 通信 IMU
- **StackedSmol**: 支持堆叠 IMU 配置

### 3.2 SlimeNRF Receiver 特性 (194KB)

- USB HID 完整实现
- ESB 协议栈
- 多追踪器管理 (最多10个)
- Flash 配对存储

### 3.3 Bootloader (505KB HEX)

包含:
- **Nordic SoftDevice S140 v7.3.0**: BLE 协议栈 (~152KB)
- **Bootloader**: DFU 支持 (~24KB)
- **MBR**: Master Boot Record

---

## 四、CH592X 引脚定义建议

### 4.1 CH592X (28-pin QFN) 完整引脚表

```
                    CH592X (28-pin QFN)
                   ┌────────────────────┐
        PA11/X32KO │1                 28│ PA10/X32KI
              VCC3 │2                 27│ VCC3
             VDCID │3                 26│ VDCIA
               VSW │4                 25│ ANT
       VIO33/VDD33 │5                 24│ VINTA
          PA8/RXD1 │6                 23│ X32MI
     PA9/TMR0/TXD1 │7                 22│ X32MO
      PB11/UD+/TMR2│8                 21│ GND
       PB10/UD-/TMR│9                 20│ PB4/RXD0/PWM7
     PB7/TXD0/PWM9 │10                19│ PB23/RST
  PB6/RTS/PWM8/AIN9│11                18│ PB22/TMR3
          PA7/AIN11│12                17│ PA15/MISO/AIN5
          PA6/AIN10│13                16│ PA14/MOSI/AIN4
          PA5/AIN1 │14                15│ PA13/SCK0/AIN3
                   └────────────────────┘
                          PA4/AIN0 (PAD)
                          PA12/SCS (PAD)
```

### 4.2 推荐引脚分配 (CH592X Tracker)

| 功能 | 引脚 | GPIO | 说明 |
|------|------|------|------|
| SPI CLK | 15 | PA13 | 硬件 SPI |
| SPI MOSI | 16 | PA14 | 硬件 SPI |
| SPI MISO | 17 | PA15 | 硬件 SPI |
| SPI CS | PAD | PA12 | IMU 片选 |
| IMU INT1 | 1 | PA11 | 数据就绪 |
| LED | 7 | PA9 | 状态指示 |
| SW/BOOT | 20 | PB4 | 用户按键 |
| USB D+ | 8 | PB11 | USB 数据 |
| USB D- | 9 | PB10 | USB 数据 |
| CHRG | 14 | PA5 | 充电检测 |
| VBAT ADC | 12 | PA7/AIN11 | 电池电压 |

### 4.3 推荐引脚分配 (CH592X Receiver)

| 功能 | 引脚 | GPIO | 说明 |
|------|------|------|------|
| USB D+ | 8 | PB11 | USB HID |
| USB D- | 9 | PB10 | USB HID |
| LED | 7 | PA9 | 状态指示 |
| RF ANT | 25 | ANT | 天线 |
| UART TX | 10 | PB7/TXD0 | 调试串口 |
| UART RX | 20 | PB4/RXD0 | 调试串口 |

---

## 五、修正优先级

### 5.1 高优先级 (必须修复)

| # | 问题 | 影响 |
|---|------|------|
| 1 | USB Setup 处理 | USB 无法枚举 |
| 2 | 主循环缺失 | 固件无实际功能 |
| 3 | 版本号管理 | 无法追踪版本 |

### 5.2 中优先级 (功能完善)

| # | 问题 | 影响 |
|---|------|------|
| 4 | Bootloader 集成 | 无法 OTA |
| 5 | RF 协议增强 | 通信不稳定 |
| 6 | 更多 IMU 支持 | 兼容性 |

### 5.3 低优先级 (优化)

| # | 问题 | 影响 |
|---|------|------|
| 7 | 功耗优化 | 续航 |
| 8 | 调试功能 | 开发体验 |

---

## 六、建议的版本号策略

### 6.1 版本号来源优先级

1. **GitHub 检测**: 从 `SlimeVR-Tracker-nRF-Receiver` 仓库获取
2. **用户设置**: 通过 `make VERSION=x.y.z` 指定
3. **默认值**: `0.4.2` (最后已知稳定版本)

### 6.2 实现方式

```makefile
# Makefile 中添加
VERSION ?= $(shell curl -s https://api.github.com/repos/SlimeVR/SlimeVR-Tracker-nRF-Receiver/releases/latest | grep -oP '"tag_name": "\K[^"]+' 2>/dev/null || echo "0.4.2")
```

---

*分析完成时间: 2026-01-17*
