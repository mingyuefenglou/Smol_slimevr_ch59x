# CH591D 原理图引脚分析报告

**分析日期**: 2026-01-13  
**芯片型号**: CH591D (20-pin QFN)  
**参考文档**: CH592/CH591 数据手册 V1.8

---

## 🔴 严重警告：原理图存在引脚标签偏移错误！

原理图中 **Pin 3 的标签缺失**，导致 **Pin 6-10 的所有引脚标签向下偏移了一位**。

---

## 一、芯片手册正确引脚定义

根据 CH592/CH591 数据手册 V1.8，CH591D (20-pin QFN) 的正确引脚定义如下：

```
                    CH591D (20-pin QFN)
    ┌─────────────────────────────────────────┐
    │                                         │
16 ─┤ VDCIA                        PA12/SCS  ├─ 20
17 ─┤ PA15/MISO                PA13/SCK0     ├─ 19
18 ─┤ PA14/MOSI                PA14/MOSI     ├─ 18
    │                                         │
    │       ┌───────────────┐                │
    │       │               │                │
    │  15 ──│ ANT    X32MI  │── 13           │
    │       │               │                │
    │  14 ──│ VINTA  X32MO  │── 12           │
    │       │               │                │
    │       │      GND      │                │
    │       │     (底板)     │                │
    │       │               │                │
    │  11 ──│ PB4    PB7    │── 10           │
    │       │               │                │
    │   9 ──│ PB10   PB11   │── 8            │
    │       │               │                │
    │   7 ──│ PA9    PA8    │── 6            │
    │       │               │                │
    │   5 ──│ VSW    VDCID  │── 4            │
    │       │               │                │
    │   3 ──│ VIO33         │                │
    │       │               │                │
    │   2 ──│ PA10   PA11   │── 1            │
    │       │               │                │
    │       └───────────────┘                │
    │                                21=GND   │
    └─────────────────────────────────────────┘
```

### 完整引脚表

| Pin | 引脚名称 | 类型 | 主要功能 | 备用功能 |
|-----|----------|------|----------|----------|
| 0 | GND | 电源 | 芯片底板接地 | - |
| 1 | PA11 | I/O | GPIO | X32KO, TMR2 |
| 2 | PA10 | I/O | GPIO | X32KI, TMR1 |
| **3** | **VIO33/VDD33** | **电源** | **I/O 电源 (3.3V)** | - |
| 4 | VDCID | 电源 | DC-DC 输入 | - |
| 5 | VSW | 电源 | DC-DC 开关输出 | - |
| **6** | **PA8** | I/O | GPIO | RXD1 |
| **7** | **PA9** | I/O | GPIO | TMR0, TXD1 |
| **8** | **PB11** | I/O | **USB D+** | TMR2_ |
| **9** | **PB10** | I/O | **USB D-** | TMR1_ |
| **10** | **PB7** | I/O | GPIO | TXD0, PWM9 |
| 11 | PB4 | I/O | GPIO | RXD0, PWM7 |
| 12 | X32MO | 模拟 | 32MHz 晶振输出 | - |
| 13 | X32MI | 模拟 | 32MHz 晶振输入 | - |
| 14 | VINTA | 电源 | RF VCO 电源 | - |
| 15 | ANT | 模拟 | RF 天线 | - |
| 16 | VDCIA | 电源 | RF LDO 输出 | - |
| 17 | PA15 | I/O | GPIO/SPI MISO | RXD0_, AIN5 |
| 18 | PA14 | I/O | GPIO/SPI MOSI | TXD0_, AIN4 |
| 19 | PA13 | I/O | GPIO/SPI SCK | PWM5, AIN3 |
| 20 | PA12 | I/O | GPIO/SPI CS | PWM4, AIN2 |
| 21 | GND | 电源 | 顶部接地 | - |

---

## 二、原理图错误分析

### 2.1 原理图 vs 芯片手册对比

| Pin | 原理图标签 | 芯片手册正确值 | 状态 | 原理图信号 |
|-----|-----------|---------------|------|-----------|
| 1 | PA11/X32KO/TMR2 | PA11/X32KO/TMR2 | ✅ 正确 | INT1 |
| 2 | PA10/X32KI/TMR1 | PA10/X32KI/TMR1 | ✅ 正确 | CHRG |
| 3 | gge741 (空) | **VIO33/VDD33** | ⚠️ **缺少标签** | (未接) |
| 4 | VDCID | VDCID | ✅ 正确 | 电源+4.7uF |
| 5 | VSW | VSW | ✅ 正确 | VDD |
| 6 | VIO33/VDD33 | **PA8/RXD1** | ❌ **错误** | ADC |
| 7 | PA8/RXD1 | **PA9/TMR0/TXD1** | ❌ **错误** | LED |
| 8 | PA9/TMR0/TXD1 | **PB11/UD+** | ❌ **错误** | D+ |
| 9 | PB11/UD+/TMR2_ | **PB10/UD-** | ❌ **错误** | D- |
| 10 | PB10/UD-/TMR1_ | **PB7/TXD0/PWM9** | ❌ **错误** | RST |
| 11 | PB7/TXD0/PWM9 | **PB4/RXD0/PWM7** | ❌ **错误** | SW0 |
| 12-21 | (正确) | (正确) | ✅ 正确 | - |

### 2.2 错误原因

**原理图中 Pin 3 (VIO33) 的标签丢失**，导致从 Pin 6 开始的所有标签向下偏移了一位。

原理图符号设计者可能将 VIO33 和 VDD33 合并到了 Pin 5 位置，忘记在 Pin 3 标注。

---

## 三、实际连接分析

### 3.1 关键发现：USB D+/D- 连接正确！

尽管原理图标签错误，但 **USB 的物理连接是正确的**：
- Pin 8 (实际 PB11/UD+) → 连接到 USB D+ 信号线 ✅
- Pin 9 (实际 PB10/UD-) → 连接到 USB D- 信号线 ✅

### 3.2 实际 GPIO 映射

| 原理图信号 | 连接到 Pin | 实际 GPIO | 代码应使用 |
|-----------|-----------|----------|-----------|
| INT1 | Pin 1 | **PA11** | GPIO_Pin_11 (GPIOA) |
| CHRG | Pin 2 | **PA10** | GPIO_Pin_10 (GPIOA) |
| ADC | Pin 6 | **PA8** | AIN12 或 GPIO |
| LED | Pin 7 | **PA9** | GPIO_Pin_9 (GPIOA) |
| D+ | Pin 8 | **PB11** | USB 硬件控制 |
| D- | Pin 9 | **PB10** | USB 硬件控制 |
| RST | Pin 10 | **PB7** | GPIO_Pin_7 (GPIOB) |
| SW0 | Pin 11 | **PB4** | GPIO_Pin_4 (GPIOB) |
| MISO | Pin 17 | **PA15** | 硬件 SPI |
| MOSI | Pin 18 | **PA14** | 硬件 SPI |
| CLK | Pin 19 | **PA13** | 硬件 SPI |
| CS | Pin 20 | **PA12** | GPIO_Pin_12 (GPIOA) |

---

## 四、代码修正要求

### 4.1 config.h 需要修改的定义

```c
// ============================================
// CH591D 20-pin QFN 正确引脚定义
// 根据原理图实际连接修正
// ============================================

// LED 状态指示灯 (原理图连接到 Pin 7)
// 原理图标签显示 PA8，但 Pin 7 实际是 PA9！
#define PIN_LED             9       // PA9 (不是 PA8!)
#define PIN_LED_PORT        GPIOA

// IMU 中断 (原理图 INT1 连接到 Pin 1)
#define PIN_IMU_INT1        11      // PA11 (Pin 1)
#define PIN_IMU_INT1_PORT   GPIOA

// 充电状态检测 (原理图 CHRG 连接到 Pin 2)
#define PIN_CHRG_DET        10      // PA10 (Pin 2)
#define PIN_CHRG_DET_PORT   GPIOA

// ADC 输入 (原理图 ADC 连接到 Pin 6)
#define PIN_ADC             8       // PA8 (Pin 6)
#define PIN_ADC_CHANNEL     AIN12   // PA8 对应 ADC 通道 12

// 用户按键 SW0 (原理图连接到 Pin 11)
// 注意：原理图标签显示 PB7，但 Pin 11 实际是 PB4！
#define PIN_SW0             4       // PB4 (不是 PB7!)
#define PIN_SW0_PORT        GPIOB

// 复位信号 (原理图 RST 连接到 Pin 10)
// 注意：原理图标签显示 PB10，但 Pin 10 实际是 PB7！
#define PIN_RST             7       // PB7 (不是 PB10!)
#define PIN_RST_PORT        GPIOB

// SPI 接口 (Pin 17-20，这些是正确的)
#define PIN_SPI_MISO        15      // PA15 (Pin 17)
#define PIN_SPI_MOSI        14      // PA14 (Pin 18)
#define PIN_SPI_CLK         13      // PA13 (Pin 19)
#define PIN_SPI_CS          12      // PA12 (Pin 20)
#define PIN_SPI_PORT        GPIOA

// USB (硬件固定，Pin 8-9)
// USB 不需要 GPIO 配置，硬件自动控制
// PB11 = USB D+ (Pin 8)
// PB10 = USB D- (Pin 9)
```

### 4.2 原理图需要修正的标签

| Pin | 当前错误标签 | 应修正为 |
|-----|-------------|---------|
| 3 | gge741 (空) | VIO33/VDD33 |
| 6 | VIO33/VDD33 | PA8/RXD1/AIN12 |
| 7 | PA8/RXD1 | PA9/TMR0/TXD1 |
| 8 | PA9/TMR0/TXD1 | PB11/UD+/TMR2_ |
| 9 | PB11/UD+/TMR2_ | PB10/UD-/TMR1_ |
| 10 | PB10/UD-/TMR1_ | PB7/TXD0/PWM9 |
| 11 | PB7/TXD0/PWM9 | PB4/RXD0/PWM7 |

---

## 五、电源连接检查

### 5.1 必须连接的电源引脚

| Pin | 名称 | 要求 | 电容 | 原理图状态 |
|-----|------|------|------|-----------|
| **3** | **VIO33** | **必须接 3.3V** | 100nF | ⚠️ **未标注！** |
| 4 | VDCID | DC-DC 输入 | 4.7uF | ✅ 正确 |
| 5 | VSW | DC-DC 开关 | 通过电感 | ✅ 正确 |
| 16 | VDCIA | RF LDO | 100nF | ✅ 正确 |

### 5.2 严重问题：VIO33 可能未连接！

原理图中 Pin 3 标签缺失，**请务必确认 PCB 上 Pin 3 已连接到 3.3V 电源**！

如果 VIO33 未连接，GPIO 将无法正常工作。

---

## 六、总结

### 6.1 发现的问题

| 问题 | 严重性 | 影响范围 |
|------|--------|----------|
| Pin 3 (VIO33) 标签缺失 | 🔴 高 | I/O 电源可能未接 |
| Pin 6-11 标签偏移 | 🟠 中 | GPIO 代码需修改 |
| USB D+/D- 标签错误 | 🟢 低 | 实际连接正确，仅标签问题 |

### 6.2 需要采取的行动

1. **立即检查 PCB**: 确认 Pin 3 (VIO33) 已连接到 3.3V
2. **修正代码引脚定义**: 按照实际 GPIO 映射修改 config.h
3. **更新原理图**: 修正 Pin 3-11 的标签
4. **测试验证**: 测试 LED、按键、USB 功能是否正常

### 6.3 好消息

- **USB 连接正确**：Pin 8/9 的 USB D+/D- 物理连接是正确的
- **SPI 连接正确**：Pin 17-20 的 SPI 引脚全部正确
- **晶振连接正确**：Pin 12-13 的 32MHz 晶振连接正确
- **RF 连接正确**：Pin 14-16 的 RF 相关引脚正确

---

*分析完成时间: 2026-01-13*
