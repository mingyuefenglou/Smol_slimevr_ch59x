# SlimeVR nRF 固件深度分析 - CH59X 实现指南

**翻译日期**: 2026-01-13  
**原文来源**: SlimeVR 官方文档及 GitHub 仓库分析  
**目标**: 为 CH59X 实现提供技术参考

---

## 概述

SlimeVR nRF 生态系统使用 **高度修改的 Enhanced ShockBurst (ESB) 协议**，采用 16 字节 HID 数据包、VQF 传感器融合算法，以及将追踪器-接收器关联存储在 Flash 中的配对机制。两个固件仓库都使用滚动提交而非语义版本控制，需要 nRF Connect SDK v3.1.0 和 SlimeVR Server v0.13.2+ 才能兼容。CH59X 实现需要精确复制 ESB 数据包结构、四元数编码和配对握手流程，才能与现有接收器通信。

---

## 一、SlimeVR-Tracker-nRF：ESB 协议与 VQF 传感器融合

### 1.1 硬件平台与 SDK 要求

追踪器固件目标是运行在 Zephyr RTOS 上的 Nordic nRF52833、nRF52840 和 nRF54L 系列微控制器。SDK 要求非常精确：**nRF Connect SDK v3.1.0** 配合 **Zephyr SDK v0.17.4**。没有正式的版本标签——固件版本通过 `info` 串口命令获取的 git commit hash 来识别。

### 1.2 RF 协议技术参数

RF 协议使用 **修改版 ESB 协议栈**，在 2.4 GHz 频段以 **2 Mbps** 数据率运行，带 16 位 CRC。接收器范围为 **7-12 米**，预计刷新率为 **100-140 Hz**。

| 参数 | 值 |
|------|------|
| 数据率 | 2 Mbps |
| CRC | 16 位 |
| 最大载荷 | 252 字节 (DPL 启用) |
| 数据包大小 (HID) | 固定 16 字节 |
| USB VID/PID | 0x1209 / 0x7690 |

### 1.3 IMU 传感器支持

支持超过 15 种传感器，包括：
- **ICM-45686** (推荐)
- **LSM6DSV** (性能媲美 BNO085)
- **BMI270** (需要 CRT 校准)
- 整个 LSM6DS 系列

通信支持 SPI（首选，功耗更低、性能更好）和 I2C（磁力计必需）。支持的磁力计包括 QMC6309、AK09940、MMC5983MA 和 IIS2MDC。

### 1.4 VQF 传感器融合算法

**VQF 传感器融合算法** 同时执行 6DoF 和 9DoF 四元数估计，具有磁场干扰抑制功能。这个来自 Laidig & Seel (2023) 的开源实现允许社区进行调优以减少漂移——相比专有融合库具有显著优势。

---

## 二、数据包格式：类型化 16 字节结构

所有追踪器通信都通过标准化的 16 字节数据包进行，包含类型字节、追踪器 ID 和 14 字节载荷数据：

```
|b0  |b1|b2-15  |
|type|id|payload|
```

### 2.1 关键数据包类型

#### Type 0 (信息包) - 传输追踪器元数据
```
|proto|batt|batt_v|temp|brd_id|mcu_id|imu_id|mag_id|fw_date(2B)|major|minor|patch|rssi|
```

#### Type 1 (完整精度四元数) - 携带旋转和加速度
```
|q0(2B)|q1(2B)|q2(2B)|q3(2B)|a0(2B)|a1(2B)|a2(2B)|
```

四元数是 **int16_t** 值，缩放到范围 [-32767, +32767]，表示归一化的四元数分量 (W, X, Y, Z 顺序)。

**转换为浮点数**: `q_float = (float)q_int16 / 32767.0f`

#### Type 2 (压缩精度) - 包含遥测数据的压缩四元数
```
|batt|batt_v|temp|q_buf(5B)|a0(2B)|a1(2B)|a2(2B)|rssi|
```

#### Type 255 (追踪器关联) - 确认 ID 分配
```
|addr(6B)|reserved(6B)|
```

### 2.2 配对协议数据包 (Types 64-67)

| 类型 | 方向 | 用途 | 关键数据 |
|------|------|------|----------|
| 64 | 追踪器→接收器 | 配对请求 | MAC 地址 (6 字节) |
| 65 | 接收器→追踪器 | 配对响应 | 接收器地址 + 信道 |
| 66 | 接收器→追踪器 | 时间同步 | 时间戳数据 |
| 67 | 接收器→追踪器 | 命令 | 命令 + 参数 |

---

## 三、接收器固件：ESB 到 USB HID 桥接

SlimeVR-Tracker-nRF-Receiver 将 ESB 无线数据包转换为 USB HID 报告发送给 SlimeVR Server。每个接收器最大容量为 **10 个追踪器**。

### 3.1 支持的硬件
- Nordic nRF52840 Dongle
- ProMicro nRF52840
- Seeed XIAO nRF52840
- 专用板如 HolyIOT-21017

### 3.2 配对表管理

接收器维护一个配对表，将 6 字节追踪器地址映射到顺序 ID (0-254)。配对信息通过 Flash 存储跨电源周期持久化。

**串口命令**:
- `pair` - 进入配对模式
- `add <address>` - 手动配对
- `list` - 显示已配对追踪器
- `clear` - 移除所有配对

### 3.3 USB HID 接口

USB HID 接口使用 VID **0x1209** 和 PID **0x7690**。Linux 系统需要 udev 规则才能非 root 访问。接收器充当透明桥接——来自追踪器的数据包以最小修改传递，同时接收器可以注入自己的数据包 (Type 192+) 用于诊断。

---

## 四、配对握手：特定状态机

配对序列遵循严格的协议：

1. **追踪器进入配对模式** - 长按按钮 5 秒 (LED 每秒闪烁 1 次)
2. **接收器进入配对模式** - 通过 `pair` 串口命令
3. **追踪器广播 Type 64 数据包** - 包含其 6 字节 MAC 地址
4. **接收器响应 Type 65** - 包含分配的信道和接收器地址
5. **接收器发送 Type 66** - 用于时间同步
6. **追踪器确认** - LED 闪烁 4 次；开始正常操作

### 4.1 手动配对流程

追踪器的地址（从 `info` 命令获取）使用 `add <address>` 添加到接收器，返回配对密钥。然后追踪器执行 `set <pairing_key>` 完成关联。

### 4.2 信道分配

信道分配是每次配对固定的——SlimeVR 的 ESB 实现 **不使用跳频**。信道（Type 65 的第 14 字节）决定 RF 频率：

```
F = 2400 + channel MHz
```

有效范围: 0-125

---

## 五、版本生态系统：nRF 缺乏正式发布

| 组件 | 当前版本 | 备注 |
|------|----------|------|
| SlimeVR-Tracker-nRF | 滚动 (1,377 提交) | 无语义版本控制 |
| SlimeVR-Tracker-nRF-Receiver | 滚动 (244 提交) | 使用 VERSION 文件 |
| SlimeVR-Tracker-ESP | **v0.7.1** (2025-11) | 稳定发布 |
| SlimeVR Server | **v18.1.0** (2025-12) | nRF 需要 ≥v0.13.2 |
| nRF Connect SDK | v3.1.0 | 需要精确版本 |
| Zephyr SDK | v0.17.4 | 需要精确版本 |

ESP 固件遵循带 GitHub 发布的语义版本控制，而 nRF 项目通过提交历史跟踪变更。预编译的 nRF 二进制文件可从社区 CI 构建获取：`Shine-Bright-Meow/SlimeNRF-Firmware-CI`。

---

## 六、CH59X 实现要求

### 6.1 兼容性必须实现的功能

CH59X 追踪器必须实现：

| 功能 | 说明 |
|------|------|
| **ESB 兼容 RF 协议** | 2 Mbps，16 位 CRC |
| **16 字节数据包格式** | 精确匹配 Type 0, 1, 2, 3, 255 结构 |
| **配对握手** | 支持 Types 64-67 用于接收器关联 |
| **int16_t 四元数编码** | 正确缩放 |
| **追踪器 ID 存储** | 非易失性存储 |
| **USB 串口接口** | 用于配置命令 |
| **电池电压上报** | 在 Info 和压缩精度数据包中 |

### 6.2 可选但推荐的功能

- **磁力计支持** (Type 4 数据包)
- **VQF 传感器融合** 或等效算法
- **6 面校准** 程序
- **深度睡眠模式** 带按钮唤醒
- **DFU 引导加载器** 用于固件更新

### 6.3 硬件特定考虑

nRF 平台的优势包括超低功耗（110mAh 电池可达 **40-60 小时**）、紧凑的 PCB 设计（~3cm × 3cm）和亚毫秒延迟。CH59X 实现应该以类似的功耗效率为目标——基于 WiFi 的 ESP 追踪器消耗明显更多电流，1350mAh 电池只能达到 **15-20 小时**。

官方文档警告 nRF 协议仍处于实验阶段：*"在这个阶段，没有任何东西是最终的，包括硬件、固件和通信协议。"* CH59X 实现应该在保持当前兼容性的同时为协议变化做好架构准备。

---

## 七、结论

构建 CH59X 兼容的 SlimeVR 追踪器需要精确实现：

1. **16 字节 HID 数据包格式**
2. **2 Mbps 的 ESB 无线协议**
3. **四步配对握手**

四元数必须使用缩放到 [-32767, +32767] 的 int16_t 编码。VQF 算法提供卓越的传感器融合，但任何满足时序要求（100+ Hz）的四元数源都可以工作。

关键兼容性取决于精确匹配数据包结构——SlimeVR Server 验证数据包类型并期望特定的字节布局。常见 nRF 板存在预编译的接收器固件，因此 CH59X 追踪器只需复制追踪器端协议即可与现有接收器和服务器基础设施通信。

---

## 八、CH59X 与 nRF 功能对比总结

### 8.1 协议兼容性

| 功能 | nRF (官方) | CH59X (当前) | 状态 |
|------|-----------|--------------|------|
| RF 协议 | ESB | 私有 TDMA | ❌ 不兼容 |
| USB HID 格式 | 16B 固定 | 64B | ⚠️ 需调整 |
| 四元数编码 | int16 Q15 | int16 Q15 | ✅ 兼容 |
| 配对流程 | 4 步握手 | 3 步握手 | ⚠️ 需扩展 |
| 跳频 | 无 (固定信道) | 有 (40 信道) | ⚠️ 不同 |

### 8.2 功能完整性

| 功能 | 实现状态 | 说明 |
|------|----------|------|
| VQF 融合 | ✅ 完成 | Q15 定点优化版 |
| IMU 驱动 | ✅ 完成 | ICM-45686, BMI270, LSM6DSV/R |
| RF 通信 | ✅ 完成 | 私有协议，非 ESB |
| USB HID | ✅ 完成 | 64 字节格式 |
| 配对持久化 | ✅ 完成 | v2 版本已实现 |
| 磁力计 | ⚠️ 部分 | 接口预留，QMC6309 待实现 |
| ESB 兼容 | ❌ 未实现 | 需要额外开发 |

### 8.3 实现建议

**方案 A: 保持独立协议 (当前)**
- 优点: 充分利用 CH59X 硬件特性，代码简洁
- 缺点: 需要专用接收器

**方案 B: 实现 ESB 兼容层**
- 工作量: 2-4 周
- 需要实现: ESB 帧格式、5 字节地址、nRF 配对协议

---

*翻译完成时间: 2026-01-13*
