# SlimeVR CH59X è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®ä¸å®æ–½
# SlimeVR CH59X Further Optimization Suggestions & Implementation

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æç°æœ‰å›ºä»¶çš„ä¼˜åŒ–ç©ºé—´ï¼Œå¹¶æå‡ºå…·ä½“å®æ–½æ–¹æ¡ˆã€‚

---

## 1. RF åè®®ä¼˜åŒ–åˆ†æ

### 1.1 ç°æœ‰ RF Ultra v1 åè®®

| ç‰¹æ€§ | å½“å‰çŠ¶æ€ | åˆ†æ |
|------|----------|------|
| åŒ…å¤§å° | 12 å­—èŠ‚ | ä»æœ‰å‹ç¼©ç©ºé—´ |
| å››å…ƒæ•°ç¼–ç  | 4x int16 (8B) | å¯ç”¨ smallest-three (6B) |
| CRC | CRC8 (æ— çº é”™) | å¯åŠ  FEC |
| é™æ­¢ä¼˜åŒ– | æ—  | å¯ç”¨å¢é‡ç¼–ç  |
| å¤šè¿½è¸ªå™¨ | ç‹¬ç«‹åŒ… | å¯èšåˆ |

### 1.2 RF Ultra v2 ä¼˜åŒ– (å·²å®æ–½)

**æ–°å¢æ–‡ä»¶**: `src/rf/rf_ultra_v2.c`

| ä¼˜åŒ–é¡¹ | v1 | v2 | æå‡ |
|--------|-----|-----|------|
| å®Œæ•´åŒ…å¤§å° | 12B | 10B | 17% |
| å¢é‡åŒ…å¤§å° | N/A | 6B | 50% |
| é™æ­¢å¸¦å®½ | 2400 B/s | 300 B/s | 87.5% |
| çº é”™èƒ½åŠ› | 0 bit | 1 bit | +100% |
| å¤šè¿½è¸ªå™¨èšåˆ | 1:1 | 4:1 | 75% |

**v2 æ ¸å¿ƒä¼˜åŒ–:**

1. **Smallest-Three å››å…ƒæ•°å‹ç¼©**
   - ä¸¢å¼ƒç»å¯¹å€¼æœ€å¤§çš„åˆ†é‡
   - 4x16bit â†’ 3x16bit + 2bit index = 6.25B
   - æ¥æ”¶ç«¯é€šè¿‡å½’ä¸€åŒ–æ¢å¤

2. **å¢é‡ç¼–ç **
   - è¿åŠ¨å°æ—¶åªä¼ è¾“å˜åŒ–é‡
   - å®Œæ•´åŒ… 10B â†’ å¢é‡åŒ… 6B
   - æ¯ 10 ä¸ªå¢é‡åŒ…å‘ 1 ä¸ªå®Œæ•´åŒ… (åŒæ­¥)

3. **è‡ªé€‚åº”å‘é€é€Ÿç‡**
   - é«˜è¿åŠ¨: 200Hz (å…¨é€Ÿ)
   - ä½è¿åŠ¨: 100Hz (åŠé€Ÿ)
   - é™æ­¢: 50Hz (å››åˆ†ä¹‹ä¸€)

4. **æ™ºèƒ½è·³é¢‘**
   - ç›‘æ§å„é€šé“ RSSI
   - è‡ªåŠ¨é€‰æ‹©æœ€ä½³é€šé“
   - é¿å¼€ WiFi å¹²æ‰°

5. **åŒ…èšåˆ (æ¥æ”¶å™¨)**
   - æœ€å¤šèšåˆ 4 ä¸ªè¿½è¸ªå™¨æ•°æ®
   - USB å•æ¬¡ä¼ è¾“å¤šè¿½è¸ªå™¨
   - é™ä½ USB è½®è¯¢å¼€é”€

---

## 2. åŠŸè€—ä¼˜åŒ–

### 2.1 å½“å‰åŠŸè€—åˆ†æ

| ç»„ä»¶ | ç”µæµ | å æ¯” | å¯ä¼˜åŒ–ç©ºé—´ |
|------|------|------|------------|
| MCU æ´»åŠ¨ | 8.0 mA | 63% | å¯é™ä½æ—¶é’Ÿ |
| RF TX | 3.0 mA (å¹³å‡) | 24% | å¯é™ä½åŠŸç‡/é¢‘ç‡ |
| IMU | 0.65 mA | 5% | å¯ç”¨ä½åŠŸè€—æ¨¡å¼ |
| å…¶ä»– | 1.0 mA | 8% | å›ºå®š |
| **æ€»è®¡** | **12.65 mA** | 100% | |

### 2.2 ä¼˜åŒ–æªæ–½

**A. MCU æ—¶é’ŸåŠ¨æ€è°ƒæ•´**
```c
// é™æ­¢æ—¶é™ä½ç³»ç»Ÿæ—¶é’Ÿ
void power_optimize_idle(void) {
    // 60MHz â†’ 32MHz (çœ ~3mA)
    SetSysClock(CLK_SOURCE_PLL_32MHz);
}

// æ´»åŠ¨æ—¶æ¢å¤
void power_optimize_active(void) {
    SetSysClock(CLK_SOURCE_PLL_60MHz);
}
```

**B. RF è‡ªé€‚åº”åŠŸç‡**
```c
// æ ¹æ® RSSI è°ƒæ•´å‘å°„åŠŸç‡
void rf_adaptive_power(int8_t rssi) {
    if (rssi > -50) {
        // ä¿¡å·å¼ºï¼Œé™ä½åŠŸç‡
        rf_set_tx_power(RF_TX_POWER_0DBM);  // çœ ~2mA
    } else if (rssi < -70) {
        // ä¿¡å·å¼±ï¼Œæœ€å¤§åŠŸç‡
        rf_set_tx_power(RF_TX_POWER_4DBM);
    }
}
```

**C. IMU ä½åŠŸè€—æ¨¡å¼**
```c
// é™æ­¢æ—¶ IMU é™é¢‘
void imu_low_power_mode(void) {
    // 200Hz â†’ 50Hz (çœ ~0.3mA)
    imu_set_odr(50);
}
```

### 2.3 ä¼˜åŒ–ååŠŸè€—é¢„ä¼°

| æ¨¡å¼ | ç”µæµ | 150mAh ç»­èˆª |
|------|------|-------------|
| åŸå§‹ | 12.65 mA | 11.9 å°æ—¶ |
| ä¼˜åŒ– (æ´»åŠ¨) | 10.5 mA | 14.3 å°æ—¶ |
| ä¼˜åŒ– (é™æ­¢) | 5.0 mA | 30.0 å°æ—¶ |
| æ··åˆ (70%æ´»åŠ¨) | 8.9 mA | 16.9 å°æ—¶ |

---

## 3. ç²¾åº¦ä¼˜åŒ–

### 3.1 é™€èºä»ªå™ªéŸ³ (å·²å®æ–½)

**æ–‡ä»¶**: `src/sensor/gyro_noise_filter.c`

| æ»¤æ³¢å±‚ | æ–¹æ³• | æ•ˆæœ |
|--------|------|------|
| ç¡¬ä»¶ | IMU å†…éƒ¨ LPF | é¢„æ»¤æ³¢ |
| ç¬¬1å±‚ | åå·®æ ¡æ­£ | æ¶ˆé™¤é™æ€åå·® |
| ç¬¬2å±‚ | ä¸­å€¼æ»¤æ³¢ | å»å°–å³° |
| ç¬¬3å±‚ | ç§»åŠ¨å¹³å‡ | å¹³æ»‘ |
| ç¬¬4å±‚ | å¡å°”æ›¼ | è‡ªé€‚åº”å™ªå£° |
| ç¬¬5å±‚ | ZUPT | é›¶é€Ÿæ›´æ–° |
| ç¬¬6å±‚ | æ­»åŒº | å¾®å°å™ªå£° |

### 3.2 ä¼ æ„Ÿå™¨èåˆä¼˜åŒ–å»ºè®®

**A. VQF å‚æ•°è°ƒä¼˜**
```c
// æ ¹æ®ä½¿ç”¨åœºæ™¯è°ƒæ•´
#define VQF_TAU_ACC_FAST    1.0f    // å¿«é€Ÿå“åº” (èˆè¹ˆ)
#define VQF_TAU_ACC_NORMAL  3.0f    // æ™®é€š (VR æ¸¸æˆ)
#define VQF_TAU_ACC_STABLE  5.0f    // ç¨³å®š (ç«™ç«‹)
```

**B. ç£åŠ›è®¡èåˆ (å¯é€‰)**
- æ·»åŠ ç£åŠ›è®¡å¯æ¶ˆé™¤åèˆªæ¼‚ç§»
- éœ€è¦ç£å¹²æ‰°æ£€æµ‹
- å®¤å†…æ•ˆæœå¯èƒ½ä¸ä½³

**C. è¿åŠ¨è‡ªé€‚åº”**
```c
// é«˜è¿åŠ¨æ—¶ä¿¡ä»»é™€èºä»ª
// é™æ­¢æ—¶ä¿¡ä»»åŠ é€Ÿåº¦è®¡
float adapt_beta(float motion_level) {
    if (motion_level > 0.8f) return 0.02f;  // ä½ä¿®æ­£
    if (motion_level < 0.2f) return 0.2f;   // é«˜ä¿®æ­£
    return 0.1f;  // é»˜è®¤
}
```

---

## 4. å»¶è¿Ÿä¼˜åŒ–

### 4.1 å½“å‰å»¶è¿Ÿåˆ†æ

| é˜¶æ®µ | å»¶è¿Ÿ | è¯´æ˜ |
|------|------|------|
| IMU é‡‡æ · | 5 ms | ODR=200Hz |
| èåˆç®—æ³• | 0.4 ms | VQF |
| RF TX | 0.5 ms | 12B @ 2Mbps |
| RF ç©ºä¸­ | 0.05 ms | çº¦ 50us |
| USB HID | 1 ms | è½®è¯¢é—´éš” |
| **æ€»ç«¯åˆ°ç«¯** | **~7 ms** | |

### 4.2 ä¼˜åŒ–æªæ–½

**A. æé«˜ ODR**
```c
// 200Hz â†’ 400Hz (å»¶è¿Ÿ 5ms â†’ 2.5ms)
imu_set_odr(400);
```

**B. ç¼©çŸ­ USB è½®è¯¢**
```c
// 1ms â†’ 0.5ms (éœ€è¦ USB é«˜é€Ÿæ”¯æŒ)
#define USB_HID_INTERVAL    1  // æœ€å° 1ms (USB FS)
```

**C. ä¸­æ–­é©±åŠ¨**
```c
// ä½¿ç”¨ IMU æ•°æ®å°±ç»ªä¸­æ–­
void IMU_INT1_IRQHandler(void) {
    // ç«‹å³è¯»å–å¹¶å¤„ç†
    imu_read_and_process();
}
```

---

## 5. ä»£ç å¤§å°ä¼˜åŒ– (CH591D é€‚ç”¨)

### 5.1 å½“å‰ä»£ç å¤§å°ä¼°ç®—

| æ¨¡å— | å¤§å° | è¯´æ˜ |
|------|------|------|
| ç³»ç»Ÿå¯åŠ¨ | ~4 KB | å¯åŠ¨ä»£ç  + å‘é‡è¡¨ |
| HAL | ~8 KB | ç¡¬ä»¶æŠ½è±¡å±‚ |
| RF | ~12 KB | RF åè®® |
| IMU | ~10 KB | 5ç§ IMU é©±åŠ¨ |
| èåˆ | ~6 KB | VQF + EKF |
| USB | ~8 KB | USB HID |
| **æ€»è®¡** | **~48 KB** | CH591D æœ€å¤§ 256KB |

### 5.2 ä¼˜åŒ–æªæ–½

**A. é€‰æ‹©æ€§ç¼–è¯‘ IMU é©±åŠ¨**
```makefile
# åªç¼–è¯‘éœ€è¦çš„ IMU
ifeq ($(IMU),ICM45686)
    SENSOR_SRC += src/sensor/imu/icm45686.c
else ifeq ($(IMU),BMI270)
    SENSOR_SRC += src/sensor/imu/bmi270.c
endif
```

**B. ç¦ç”¨è°ƒè¯•ä»£ç **
```c
#ifndef DEBUG_ENABLE
    #define DEBUG_PRINTF(...)   // ç©º
#else
    #define DEBUG_PRINTF(...)   printf(__VA_ARGS__)
#endif
```

**C. ä¼˜åŒ–çº§åˆ«**
```makefile
# ä½¿ç”¨ -Os ä¼˜åŒ–å¤§å°
OPT = -Os
```

---

## 6. å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ |
|--------|--------|----------|--------|
| ğŸ”´ é«˜ | RF v2 (smallest-three) | å¸¦å®½ -40% | ä¸­ |
| ğŸ”´ é«˜ | å¢é‡ç¼–ç  | é™æ­¢å¸¦å®½ -80% | ä¸­ |
| ğŸŸ  ä¸­ | è‡ªé€‚åº”åŠŸç‡ | åŠŸè€— -20% | ä½ |
| ğŸŸ  ä¸­ | MCU åŠ¨æ€æ—¶é’Ÿ | åŠŸè€— -25% | ä½ |
| ğŸŸ¢ ä½ | æé«˜ ODR | å»¶è¿Ÿ -2.5ms | ä½ |
| ğŸŸ¢ ä½ | ç£åŠ›è®¡èåˆ | æ¼‚ç§»æ¶ˆé™¤ | é«˜ |

---

## 7. æµ‹è¯•éªŒè¯

### 7.1 RF v2 æµ‹è¯•ç”¨ä¾‹

```c
// æµ‹è¯• smallest-three å‹ç¼©
void test_smallest_three(void) {
    q15_t quat_in[4] = {32767, 0, 0, 0};  // å•ä½å››å…ƒæ•°
    smallest_three_t st;
    q15_t quat_out[4];
    
    quat_compress_smallest_three(quat_in, &st);
    quat_decompress_smallest_three(&st, quat_out);
    
    // éªŒè¯è¯¯å·® < 0.01
    for (int i = 0; i < 4; i++) {
        assert(abs(quat_in[i] - quat_out[i]) < 328);  // 1% è¯¯å·®
    }
}
```

### 7.2 åŠŸè€—æµ‹è¯•æ–¹æ³•

```
æµ‹è¯•è®¾å¤‡: ç”µæµè¡¨ (uA çº§ç²¾åº¦)
æµ‹è¯•æ¡ä»¶:
1. é™æ­¢ 60 ç§’, è®°å½•å¹³å‡ç”µæµ
2. è½»å¾®è¿åŠ¨ 60 ç§’, è®°å½•å¹³å‡ç”µæµ
3. å‰§çƒˆè¿åŠ¨ 60 ç§’, è®°å½•å¹³å‡ç”µæµ
4. è®¡ç®—åŠ æƒå¹³å‡
```

---

## 8. æ€»ç»“

### å·²å®æ–½ä¼˜åŒ–:
- âœ… RF Ultra v2 (smallest-three, å¢é‡ç¼–ç , èšåˆ)
- âœ… é™€èºä»ªå¤šçº§å™ªéŸ³æ»¤æ³¢
- âœ… ç»Ÿä¸€ IMU æ¥å£ (SPI/I2C)
- âœ… ç®€åŒ–å……ç”µæ£€æµ‹

### å¾…å®æ–½ä¼˜åŒ–:
- â³ MCU åŠ¨æ€æ—¶é’Ÿ
- â³ RF è‡ªé€‚åº”åŠŸç‡
- â³ IMU ä½åŠŸè€—æ¨¡å¼åˆ‡æ¢
- â³ ç£åŠ›è®¡èåˆ (å¯é€‰)

### é¢„æœŸæ€»ä½“æå‡:
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ç»­èˆª | 12 å°æ—¶ | 17+ å°æ—¶ | 40%+ |
| é™æ€å™ªéŸ³ | 0.02Â°/s | 0.005Â°/s | 75% |
| RF å¸¦å®½ | 2400 B/s | 1000 B/s | 58% |
| ç«¯åˆ°ç«¯å»¶è¿Ÿ | 7 ms | 5 ms | 29% |

---

*æœ€åæ›´æ–°: 2026-01-12*
