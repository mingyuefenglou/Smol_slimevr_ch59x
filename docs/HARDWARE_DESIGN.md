# SlimeVR CH592 Tracker 硬件设计文档

## 电源系统架构

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                      Power System                        │
                    └─────────────────────────────────────────────────────────┘

    Type-C 5V ──────┬──────────────────┬────────────────────────────────────────
                    │                  │
                    │              ┌───┴───┐
                    │              │TP4054 │
                    │              │充电IC │
                    │              └───┬───┘
                    │                  │ BAT
                    │              ┌───┴───┐
                    │              │  BAT  │
                    │              │3.7-4.2V│
                    │              └───┬───┘
                    │                  │
                    │              ┌───┴───┐
                    │              │  LDO  │
                    │              │ 3.3V  │
                    │              └───┬───┘
                    │                  │ 3.3V
                    │          ┌───────┴───────┐
                    │          │               │
                    │      ┌───┴───┐       ┌───┴───┐
                    │      │CH592  │       │ IMU   │
                    │      │       │       │ICM456 │
                    │      └───────┘       └───────┘
                    │
                    │
    USB 5V ─────────┤
    Detection       │
                    │
               ┌────┴────┐
               │  10KΩ   │
               └────┬────┘
                    │
                    ├──────────────► PA10 (USB_POWER_PIN)
                    │
               ┌────┴────┐
               │  10KΩ   │
               └────┬────┘
                    │
                   GND
```

## USB 5V 检测电路

### 工作原理

当 Type-C 插入时，5V 电源通过分压电阻产生 2.5V 信号给 CH592 的 PA10 引脚：

- 输入: 5V (Type-C VBUS)
- 分压: 10KΩ / 10KΩ = 1/2
- 输出: 2.5V (安全用于 3.3V GPIO)
- 逻辑: HIGH = USB 已连接, LOW = USB 未连接

### 元器件列表

| 标号 | 型号 | 封装 | 数量 | 说明 |
|------|------|------|------|------|
| R1 | 10KΩ | 0402 | 1 | 上分压电阻 |
| R2 | 10KΩ | 0402 | 1 | 下分压电阻 |

### PCB 布局注意事项

1. 分压电阻靠近 Type-C 接口放置
2. PA10 走线远离高频信号
3. 可在 PA10 附近添加 100pF 滤波电容

## GPIO 引脚分配

### CH591D (20-pin QFN)

| 引脚 | 功能 | 方向 | 说明 |
|------|------|------|------|
| PA11 | IMU_INT1 | Input | IMU 数据就绪中断 |
| PA10 | CHG_DETECT_PIN | Input (Pull-up) | TP4054 充电状态检测 |
| PA8 | VBAT_ADC_PIN | ADC Input | 电池电压检测 |
| PA9 | LED_PIN | Output | 工作指示灯 |
| PB11 | USB_DP | USB | USB D+ |
| PB10 | USB_DM | USB | USB D- |
| PB7 | RST_PIN | Input (Pull-up) | 复位按键 (更新模式) |
| PA12 | SPI_CS | Output | IMU SPI 片选 |
| PA13 | SPI_CLK | Output | IMU SPI 时钟 |
| PA14 | SPI_MOSI | Output | IMU SPI MOSI |
| PA15 | SPI_MISO | Input | IMU SPI MISO |
| PB4 | SW0_PIN | Input (Pull-up) | 自定义按键 |

### CH592X (28-pin QFN)

| 引脚 | 功能 | 方向 | 说明 |
|------|------|------|------|
| PA4 | SW1_PIN | Input (Pull-up) | 功能按键 (休眠/配对) |
| PA5 | CHG_DETECT_PIN | Input (Pull-up) | TP4054 充电状态检测 |
| PA6 | VBAT_ADC_PIN | ADC Input | 电池电压检测 |
| PA7 | RST_PIN | Input (Pull-up) | 复位按键 (更新模式) |
| PA8 | LED_PIN | Output | 工作指示灯 |
| PA10 | USB_POWER_PIN | Input | USB 5V 检测 |
| PB12 | I2C_SDA | I/O | IMU 数据线 |
| PB13 | I2C_SCL | Output | IMU 时钟线 |

## 按键功能说明

### SW1 按键 (PA4)

| 操作 | 触发条件 | 功能 | LED 状态 |
|------|----------|------|----------|
| 长按 | >2秒 | 进入休眠模式 | 熄灭 |
| 双击 | 400ms内双击 | 进入配对模式 | 1.5秒慢闪 |

### RST 按键 (PA7)

| 操作 | 触发条件 | 功能 | LED 状态 |
|------|----------|------|----------|
| 双击 | 500ms内双击 + USB已连接 | 进入更新模式 | 100ms快闪 |

## 更新模式详细说明

### 进入条件

1. Type-C 已插入 (PA10 = HIGH)
2. RST 按键双击

### 更新流程

```
┌──────────────────┐
│  检测 RST 双击   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ USB 已连接?      │──── No ──→ 忽略
└────────┬─────────┘
         │ Yes
         ▼
┌──────────────────┐
│ 进入更新模式     │
│ LED 快速闪烁     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ USB MSC 枚举     │
│ "NiNi_MingYue_   │
│  Slime"          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 等待 UF2 文件    │
│ (超时: 3分钟)    │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│成功    │ │失败/超时│
└───┬────┘ └───┬────┘
    │          │
    ▼          ▼
┌────────┐ ┌────────────┐
│重启系统│ │生成错误日志│
└────────┘ │重新进入更新│
           │模式         │
           └────────────┘
```

### USB 驱动器内容

```
NiNi_MingYue_Slime (8MB)
├── README.TXT      (使用说明)
├── INFO.TXT        (设备信息)
└── ERROR.LOG       (仅在更新失败时生成)
```

### UF2 文件格式

使用 UF2 (USB Flashing Format) 格式进行固件更新：

- Family ID: 0x4B37B5A5 (CH592)
- 目标地址: 0x00001000 - 0x0006FFFF
- 块大小: 476 字节有效载荷
- 自动校验和重试

## 错误处理

### 更新失败时

1. 系统不做任何修改 (原固件保持不变)
2. 自动生成 ERROR.LOG 文件
3. 设备重启后重新进入更新模式
4. 用户可查看错误日志排查问题

### 错误类型

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| INVALID_MAGIC | UF2 文件格式错误 | 重新生成 UF2 文件 |
| INVALID_FAMILY | 设备型号不匹配 | 使用正确的固件 |
| INVALID_ADDRESS | 地址越界 | 检查链接脚本 |
| FLASH_ERASE | Flash 擦除失败 | 检查硬件 |
| FLASH_WRITE | Flash 写入失败 | 检查硬件 |
| VERIFY_FAILED | 校验失败 | 重试更新 |
| TIMEOUT | 3分钟超时 | 重新操作 |
| USB_DISCONNECT | USB 断开 | 保持连接 |

## 参考电路图

### TP4054 充电电路

```
        5V ─────┬──────────────────────────────
                │
            ┌───┴───┐
            │TP4054 │
            │  VCC  │
            │  CHRG─├───────────────────► PA5 (LOW=充电中)
            │  BAT ─├───────────┬───────► BAT+
            │  GND  │           │
            └───┬───┘       ┌───┴───┐
                │           │ 4.7μF │
               GND          └───┬───┘
                               GND
```

### LDO 稳压电路

```
    BAT ────┬──────────────────────────────────
            │
        ┌───┴───┐
        │XC6206 │
        │ VIN   │
        │ VOUT ─├───────┬───────────────► 3.3V
        │ GND   │   ┌───┴───┐
        └───┬───┘   │ 10μF  │
            │       └───┬───┘
           GND         GND
```
