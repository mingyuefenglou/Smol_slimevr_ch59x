# SlimeVR CH59X 专用射频通信协议设计文档

## 1. 系统概述

本文档定义了一套基于 CH59X 私有射频模式的专用通信协议，用于 SlimeVR 追踪器系统。该系统由一个接收端（Receiver/Dongle）和最多 10 个发射端（Tracker）组成。

### 1.1 设计目标

| 参数 | 目标值 | 说明 |
|------|--------|------|
| 最大发射端数量 | 10 | 支持全身追踪 |
| 最小发射端数量 | 6 | 基础配置 |
| 数据更新率 | 200Hz | 单个追踪器 |
| 系统延迟 | <5ms | 端到端 |
| 抗干扰能力 | 高 | 跳频 + 信道评估 |
| 通信距离 | >10m | 室内环境 |

### 1.2 频段规划

使用 2.4GHz ISM 频段，划分为 40 个可用信道：

```
信道 0-39: 2402MHz - 2480MHz (2MHz 间隔)
避开 WiFi 信道 1/6/11 的中心频率
```

## 2. 协议架构

### 2.1 时分多址 (TDMA) 帧结构

```
┌─────────────────── 超帧 (5ms) ───────────────────┐
│                                                   │
│ ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬────┐ │
│ │Sync │ T0  │ T1  │ T2  │ ... │ T9  │Guard│Hop │ │
│ │250μs│400μs│400μs│400μs│     │400μs│200μs│50μs│ │
│ └─────┴─────┴─────┴─────┴─────┴─────┴─────┴────┘ │
└───────────────────────────────────────────────────┘

Sync:  接收端广播同步信标
T0-T9: 各发射端的专用时隙
Guard: 保护间隔
Hop:   跳频切换时间
```

### 2.2 时隙分配计算

```
单时隙时长: 400μs
  - 数据传输: 300μs (可传输 ~75 字节 @ 2Mbps)
  - ACK 响应: 50μs
  - 切换时间: 50μs

10 个发射端 × 400μs = 4000μs
同步信标: 250μs
保护间隔: 200μs
跳频切换: 50μs
预留: 500μs
───────────────────
总计: 5000μs = 5ms

数据更新率: 1000ms / 5ms = 200Hz ✓
```

### 2.3 数据包格式

#### 2.3.1 同步信标包 (Receiver → All Trackers)

```
┌────────┬────────┬────────┬────────┬────────┬────────┐
│Preamble│ SyncW  │ Type   │FrameNo │ ChMap  │  CRC   │
│ 1 byte │ 4 bytes│ 1 byte │ 2 bytes│ 5 bytes│ 2 bytes│
└────────┴────────┴────────┴────────┴────────┴────────┘

Type: 0x01 = 正常同步, 0x02 = 配对模式
FrameNo: 帧序号 (用于时隙同步)
ChMap: 跳频信道映射表
```

#### 2.3.2 追踪器数据包 (Tracker → Receiver)

```
┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐
│Preamble│ SyncW  │TrackerID│ SeqNo  │  Quat  │ Accel  │ Status │  CRC   │
│ 1 byte │ 4 bytes│ 1 byte │ 1 byte │ 8 bytes│ 6 bytes│ 2 bytes│ 2 bytes│
└────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘

Quat: 四元数 (4×int16, 压缩格式)
Accel: 加速度 (3×int16, mg 单位)
Status: 电池电量 + 状态标志
```

#### 2.3.3 ACK 包 (Receiver → Tracker)

```
┌────────┬────────┬────────┬────────┬────────┐
│Preamble│ SyncW  │TrackerID│ AckSeq │  CRC   │
│ 1 byte │ 4 bytes│ 1 byte │ 1 byte │ 2 bytes│
└────────┴────────┴────────┴────────┴────────┘
```

## 3. 配对机制

### 3.1 配对流程

```
           Receiver                         Tracker
              │                                │
              │  [按下配对按钮]                 │
              ▼                                │
         进入配对模式                           │
         固定信道 37                           │
              │                                │
              │◄─────── 配对请求 ──────────────│
              │         (MAC地址)              │
              │                                │
              │──────── 配对响应 ─────────────►│
              │    (分配 TrackerID 0-9)        │
              │                                │
              │◄─────── 配对确认 ──────────────│
              │                                │
         保存配对信息                     保存配对信息
              │                                │
              ▼                                ▼
         正常工作模式                      正常工作模式
```

### 3.2 配对数据存储

接收端存储：
- 已配对追踪器 MAC 地址列表 (最多 10 个)
- 每个追踪器分配的 ID (0-9)
- 网络密钥 (用于数据加密，可选)

发射端存储：
- 接收端 MAC 地址
- 分配的 TrackerID
- 网络密钥

## 4. 跳频策略

### 4.1 跳频序列生成

使用基于帧序号的伪随机跳频：

```c
uint8_t get_channel(uint16_t frame_no, uint32_t seed) {
    uint32_t hash = frame_no * 0x9E3779B9 + seed;
    hash ^= (hash >> 16);
    hash *= 0x85EBCA6B;
    return hash % 40;  // 40 个可用信道
}
```

### 4.2 信道质量评估

接收端持续评估各信道质量，标记干扰信道：

```
信道评估指标:
- 丢包率 > 10%: 标记为差
- 丢包率 > 30%: 临时禁用
- 每 10 秒重新评估
```

## 5. USB 通信协议

### 5.1 协议选择分析

| 协议 | 速率 | 延迟 | 复杂度 | 兼容性 |
|------|------|------|--------|--------|
| CDC Serial | 12Mbps | 1ms | 低 | 优秀 |
| HID | 64KB/s | 1ms | 中 | 优秀 |
| Bulk | 12Mbps | 可变 | 高 | 良好 |

**选择 CDC Serial (虚拟串口)**

理由：
1. 数据量计算：10 追踪器 × 20 字节 × 200Hz = 40KB/s，远低于 12Mbps
2. 开发简单，调试方便
3. 与 SlimeVR Server 兼容性好
4. Windows/Linux/Mac 免驱动

### 5.2 USB 数据帧格式

```
┌────────┬────────┬────────┬────────────────────────┬────────┐
│ Header │ Length │ Type   │       Payload          │Checksum│
│ 0xAA55 │ 1 byte │ 1 byte │     Variable           │ 1 byte │
└────────┴────────┴────────┴────────────────────────┴────────┘

Type 定义:
0x01: 追踪器数据 (多包合并)
0x02: 状态信息
0x03: 配对状态
0x04: 命令响应
```

### 5.3 追踪器数据合并上报

```
┌────────┬────────┬────────┬────────────────────────────────┐
│ Header │ Count  │TrackerID│ Quat(8) + Accel(6) + Status(2)│
│ 0xAA55 │ N      │   0    │         16 bytes               │
│        │        │   1    │         16 bytes               │
│        │        │  ...   │         ...                    │
│        │        │  N-1   │         16 bytes               │
└────────┴────────┴────────┴────────────────────────────────┘

每 5ms 上报一次，包含所有活跃追踪器数据
单帧最大: 4 + 10×17 = 174 字节
```

## 6. 状态机设计

### 6.1 接收端状态机

```
                    ┌─────────────┐
                    │    IDLE     │
                    │  (上电初始) │
                    └──────┬──────┘
                           │ 初始化完成
                           ▼
┌─────────────┐      ┌─────────────┐
│   PAIRING   │◄─────│   NORMAL    │
│  (配对模式) │ 按钮  │  (正常工作) │
└──────┬──────┘      └──────┬──────┘
       │                    │
       │ 配对完成/超时       │ 错误
       │                    ▼
       │             ┌─────────────┐
       └────────────►│    ERROR    │
                     │  (错误恢复) │
                     └─────────────┘
```

### 6.2 发射端状态机

```
                    ┌─────────────┐
                    │    INIT     │
                    │  (初始化)   │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              │ 未配对                   │ 已配对
              ▼                         ▼
       ┌─────────────┐           ┌─────────────┐
       │  UNPAIRED   │           │  SEARCHING  │
       │ (等待配对)  │           │ (搜索接收端)│
       └──────┬──────┘           └──────┬──────┘
              │ 收到配对响应             │ 收到同步信标
              ▼                         ▼
       ┌─────────────┐           ┌─────────────┐
       │  PAIRING    │           │  SYNCED     │
       │ (配对过程)  │           │ (已同步)    │
       └──────┬──────┘           └──────┬──────┘
              │ 配对成功                 │ 开始发送
              │                         ▼
              │                  ┌─────────────┐
              └─────────────────►│  RUNNING    │
                                 │ (正常运行)  │
                                 └─────────────┘
```

## 7. 功耗优化

### 7.1 发射端功耗策略

| 状态 | 动作 | 功耗 |
|------|------|------|
| 活跃 | 传感器采样 + RF 发送 | ~15mA |
| 空闲 | 等待时隙 | ~3mA |
| 休眠 | 无活动 30s 后 | ~10μA |

### 7.2 时隙外休眠

发射端在非自己时隙时进入微休眠状态，仅在同步信标和自己时隙时唤醒。

## 8. 实现清单

### 8.1 接收端模块

- [ ] RF 驱动 (私有模式)
- [ ] TDMA 调度器
- [ ] 跳频管理器
- [ ] 配对管理器
- [ ] USB CDC 驱动
- [ ] 协议解析器
- [ ] LED/按钮控制

### 8.2 发射端模块

- [ ] RF 驱动 (私有模式)
- [ ] 时隙同步器
- [ ] 传感器融合
- [ ] 数据压缩
- [ ] 电源管理
- [ ] 配对逻辑

## 9. 与 SlimeVR Server 兼容性

USB 数据格式设计为与 SlimeVR Server 兼容，需要实现：
1. 串口枚举和识别
2. 追踪器发现协议
3. 四元数/加速度数据格式转换
4. 校准命令转发
